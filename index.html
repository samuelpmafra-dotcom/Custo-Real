<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Custo Real - Samuel Mafra</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./favicon.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <meta name="theme-color" content="#1f3a5f" />

  <!-- ✅ Novo padrão (remove o aviso de deprecated) -->
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- ✅ Mantém compatibilidade iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React e Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Ícones -->
<script src="https://unpkg.com/lucide@latest"></script>

  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Constantes do Modelo de Cálculo
    const FIX_INFLACAO_PCT = 0;
    const FIX_ICMS_CORREC_D = 0;
    const FIX_ICMS_REAL_D = 10;
    const FIX_DIAS_FORMACAO = 15;
    const FIX_FRETE_VP_DIAS = 15;
    const STORAGE_KEY = "custo_real_portavel_v3";

    // Utilitários
    const truncar = (v, casas = 4) => {
      const f = Math.pow(10, casas);
      return Math.floor((v || 0) * f) / f;
    };

    const formatBRL = (v) =>
      (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4, maximumFractionDigits: 4 });

    const formatPct = (v) =>
      (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 }) + '%';

    // Ícones (Lucide)
    const Icon = ({ name, size = 18, className = "" }) => {
      useEffect(() => {
        if (window.lucide && typeof window.lucide.createIcons === "function") {
          window.lucide.createIcons();
        }
      }, [name]);

      return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
    };

    const App = () => {
      const [globals, setGlobals] = useState({ taxaFin: 1.8 });
      const [suppliers, setSuppliers] = useState([]);
      const [results, setResults] = useState([]);

      // Inicialização
      useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            setGlobals(parsed.g || { taxaFin: 1.8 });
            setSuppliers(parsed.s || []);
          } catch (e) {
            console.error(e);
          }
        } else {
          setSuppliers([{
            id: Date.now().toString(),
            nome: 'Fornecedor 1',
            valor: 0, ipi: 0, pis: 1.65, cofins: 7.6, prazo: 0, frete: 0
          }]);
        }
      }, []);

      // Auto-salvamento
      useEffect(() => {
        if (suppliers.length > 0) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ g: globals, s: suppliers }));
        }
      }, [globals, suppliers]);

      const handleAddSupplier = () => {
        setSuppliers([...suppliers, {
          id: Date.now().toString(),
          nome: `Fornecedor ${suppliers.length + 1}`,
          valor: 0, ipi: 0, pis: 1.65, cofins: 7.6, prazo: 0, frete: 0
        }]);
      };

      const handleUpdateSupplier = (id, field, val) => {
        setSuppliers(suppliers.map(s => s.id === id ? { ...s, [field]: val } : s));
      };

      const handleRemoveSupplier = (id) => {
        if (suppliers.length > 1) setSuppliers(suppliers.filter(s => s.id !== id));
      };

      const handleCalculate = () => {
        const taxaFin = globals.taxaFin / 100;
        const inflacao = FIX_INFLACAO_PCT / 100;

        const expInflacao = (30 - FIX_DIAS_FORMACAO + FIX_ICMS_CORREC_D) / 30;
        const expFinanceiroImposto = (30 - FIX_DIAS_FORMACAO + FIX_ICMS_REAL_D) / 30;

        const fatorInflacao = Math.pow((1 + inflacao), expInflacao);
        const fatorFinImposto = Math.pow((1 + taxaFin), -expFinanceiroImposto);

        const computed = suppliers
          .filter(s => s.valor > 0)
          .map(s => {
            const prazoMeses = s.prazo / 30;
            const ipiValor = s.valor * (s.ipi / 100);

            const A = truncar(s.valor * Math.pow((1 + taxaFin), -prazoMeses), 4);
            const D = truncar(ipiValor * (Math.pow((1 + taxaFin), prazoMeses) - 1), 4);

            const freteNom = (s.valor + ipiValor) * (s.frete / 100);
            const E = truncar(freteNom * Math.pow((1 + taxaFin), -(FIX_FRETE_VP_DIAS / 30)), 4);

            const B = truncar((s.valor * (s.pis / 100)) * fatorInflacao * fatorFinImposto, 4);
            const C = truncar((s.valor * (s.cofins / 100)) * fatorInflacao * fatorFinImposto, 4);

            const Final = truncar(A + D + E - B - C, 4);

            return { ...s, A, B, C, D, E, Final };
          })
          .sort((a, b) => a.Final - b.Final);

        setResults(computed);
        setTimeout(() => document.getElementById('results-area')?.scrollIntoView({ behavior: 'smooth' }), 150);
      };

      const handleExportCSV = () => {
        const headers = ["Fornecedor", "Valor", "IPI %", "PIS %", "COFINS %", "Prazo", "Frete %", "VP Valor (A)", "Custo IPI (D)", "Frete VP (E)", "PIS Adj (B)", "COF Adj (C)", "Custo Real Final"];
        const rows = results.map(r => [
          r.nome, r.valor, r.ipi, r.pis, r.cofins, r.prazo, r.frete, r.A, r.D, r.E, r.B, r.C, r.Final
        ]);
        const csvContent = "\ufeff" + [headers, ...rows].map(e => e.join(";")).join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `comparativo_custo_real_${new Date().toLocaleDateString('pt-BR')}.csv`;
        link.click();
      };

      const handleReset = () => {
        if (confirm("Deseja apagar todos os dados inseridos?")) {
          localStorage.removeItem(STORAGE_KEY);
          window.location.reload();
        }
      };

      return (
        <div className="min-h-screen pb-32">
          {/* ... seu JSX continua exatamente igual daqui pra baixo ... */}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <!-- Registrar Service Worker (offline básico) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>

